---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const gardenNotes = (await getCollection('garden'))
  .filter(note => !note.data.draft);

// Get 5 random notes
function getRandomNotes(notes: any[], count: number) {
  const shuffled = [...notes].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
}

const selectedNotes = getRandomNotes(gardenNotes, 5);
---

<BaseLayout title="Canvas" description="Explore topics in a visual canvas">
  <div class="test-container" id="container">
    <h1>Canvas</h1>
    <p>The card below should be draggable within the container.</p>

    <div class="drag-area" id="dragArea">
      <button class="fullscreen-button" id="fullscreenBtn" aria-label="Toggle fullscreen">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
        </svg>
      </button>

      <button class="refresh-button" id="refreshBtn" aria-label="Refresh cards">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
        </svg>
      </button>

      {selectedNotes.map((note, index) => (
        <div class="draggable-card" id={`card${index + 1}`} data-note-slug={note.slug}>
          <img src="/src/content/test-image.png" alt={note.data.title} class="card-image" />
          <a href={`/garden/${note.slug}`} class="card-link">
            <h3 class="card-title">{note.data.title}</h3>
            <div class="hover-preview">
              <div class="preview-header">
                <h2>{note.data.title}</h2>
                {note.data.date && (
                  <div class="preview-date">
                    {note.data.date.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </div>
                )}
              </div>
              {note.data.description && (
                <p class="preview-description">{note.data.description}</p>
              )}
              {note.data.tags && note.data.tags.length > 0 && (
                <div class="preview-tags">
                  {note.data.tags.map((tag: string) => (
                    <span class="preview-tag">{tag}</span>
                  ))}
                </div>
              )}
            </div>
          </a>
          {note.data.tags && note.data.tags.length > 0 && (
            <div class="card-tags">
              {note.data.tags.map((tag: string) => (
                <span class="card-tag">{tag}</span>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  </div>
</BaseLayout>

<script>
  import { Draggable } from '@neodrag/vanilla';

  const dragArea = document.getElementById('dragArea');
  const cards = ['card1', 'card2', 'card3', 'card4', 'card5'];
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const container = document.getElementById('container');
  let highestZIndex = 100;

  function initializeDraggable() {
    cards.forEach(cardId => {
      const card = document.getElementById(cardId);
      if (card && dragArea) {
        new Draggable(card, {
          bounds: 'parent',
          handle: card,
          onDragStart: (data) => {
            highestZIndex++;
            card.style.zIndex = highestZIndex;
          }
        });
      }
    });
  }

  initializeDraggable();

  // Fullscreen toggle
  fullscreenBtn?.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      dragArea?.requestFullscreen().catch(err => {
        console.error(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  });

  // Refresh button - reload the page to get new random cards
  refreshBtn?.addEventListener('click', () => {
    window.location.reload();
  });

  // Position hover preview next to card
  const cardLinks = document.querySelectorAll('.card-link');

  cardLinks.forEach(link => {
    link.addEventListener('mouseenter', () => {
      const preview = link.querySelector('.hover-preview');
      const card = link.closest('.draggable-card');

      if (preview && card) {
        const cardRect = card.getBoundingClientRect();
        const canvasRect = dragArea.getBoundingClientRect();
        const previewWidth = 350;

        // Check if there's space on the right
        const spaceOnRight = canvasRect.right - cardRect.right;

        if (spaceOnRight < previewWidth + 40) {
          // Not enough space on right, show on left
          preview.style.left = 'auto';
          preview.style.right = 'calc(100% + 20px)';
        } else {
          // Show on right (default)
          preview.style.left = 'calc(100% + 20px)';
          preview.style.right = 'auto';
        }
      }
    });
  });

  console.log('All cards initialized');
</script>

<style>
  .test-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .test-container h1 {
    margin-bottom: 1rem;
  }

  .test-container p {
    color: var(--color-text-muted);
    margin-bottom: 2rem;
  }

  .drag-area {
    position: relative;
    width: 100%;
    height: 600px;
    background-color: var(--color-bg);
    background-image: radial-gradient(circle, var(--color-text-muted) 1px, transparent 1px);
    background-size: 20px 20px;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
  }

  .draggable-card {
    position: absolute;
    width: 180px;
    height: 252px;
    background: var(--color-card);
    border: 3px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: grab;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    user-select: none;
    gap: 0.75rem;
    z-index: 1;
  }

  /* Flexoki color borders - random selection */
  #card1 {
    border-color: #D14D41; /* Flexoki Red */
  }

  #card2 {
    border-color: #4385BE; /* Flexoki Blue */
  }

  #card3 {
    border-color: #879A39; /* Flexoki Green */
  }

  #card4 {
    border-color: #D14D41; /* Flexoki Red */
  }

  #card5 {
    border-color: #4385BE; /* Flexoki Blue */
  }

  .card-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 0.5rem;
  }

  .card-link {
    text-decoration: none;
    color: inherit;
    text-align: center;
    position: relative;
  }

  .card-link:hover .card-title {
    color: var(--color-primary);
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
    text-align: center;
    line-height: 1.4;
    transition: color 0.2s;
  }

  /* Hover preview card */
  .hover-preview {
    display: none;
    position: absolute;
    width: 350px;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    pointer-events: none;
    text-align: left;
    left: calc(100% + 20px);
    top: 0;
  }

  .card-link:hover .hover-preview {
    display: block;
  }

  .preview-header {
    margin-bottom: 1rem;
  }

  .preview-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
  }

  .preview-date {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
  }

  .preview-description {
    font-size: 1rem;
    color: var(--color-text);
    line-height: 1.6;
    margin: 0 0 1rem 0;
  }

  .preview-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .preview-tag {
    font-size: 0.85rem;
    padding: 0.35rem 0.75rem;
    background: var(--color-hover);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    color: var(--color-text-muted);
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    justify-content: center;
  }

  .card-tag {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    background: var(--color-hover);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-muted);
  }

  /* Position each card differently */
  #card1 {
    top: 50%;
    left: 20%;
    transform: translate(-50%, -50%);
  }

  #card2 {
    top: 50%;
    left: 35%;
    transform: translate(-50%, -50%);
  }

  #card3 {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  #card4 {
    top: 50%;
    left: 65%;
    transform: translate(-50%, -50%);
  }

  #card5 {
    top: 50%;
    left: 80%;
    transform: translate(-50%, -50%);
  }

  .draggable-card:active {
    cursor: grabbing;
  }

  .draggable-card:hover {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
  }

  .fullscreen-button,
  .refresh-button {
    position: absolute;
    width: 40px;
    height: 40px;
    background: var(--color-card);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text);
    transition: all 0.2s;
    z-index: 100;
  }

  .fullscreen-button {
    top: 1rem;
    right: 1rem;
  }

  .refresh-button {
    top: 1rem;
    right: 3.5rem;
  }

  .fullscreen-button:hover,
  .refresh-button:hover {
    background: var(--color-hover);
    transform: scale(1.05);
  }

  .fullscreen-button svg,
  .refresh-button svg {
    width: 20px;
    height: 20px;
  }

  /* Fullscreen styles */
  .drag-area:fullscreen {
    background-color: var(--color-bg);
    background-image: radial-gradient(circle, var(--color-text-muted) 1px, transparent 1px);
    background-size: 20px 20px;
  }
</style>
