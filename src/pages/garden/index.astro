---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const gardenNotes = (await getCollection('garden'))
  .filter(note => !note.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const allTags = [...new Set(gardenNotes.flatMap(note => note.data.tags))].sort();
---

<BaseLayout title="Digital Garden" description="Explore my growing collection of notes and thoughts">
  <div class="header">
    <div class="header-content">
      <div>
        <h1>Digital Garden</h1>
        <p class="subtitle">
          A collection of evolving notes, ideas, and thoughts. These are living documents that
          grow and change over time.
        </p>
      </div>
      <button id="layoutToggle" class="layout-toggle" aria-label="Toggle layout">
        <span class="toggle-icon">âŠž</span>
        <span class="toggle-text">Masonry</span>
      </button>
    </div>
  </div>

  <div class="search-container">
    <input
      type="text"
      id="searchInput"
      class="search-input"
      placeholder="Search notes..."
      aria-label="Search notes"
    />
  </div>

  {allTags.length > 0 && (
    <div class="tags-filter">
      <div class="tags">
        {allTags.map(tag => (
          <span class="tag">{tag}</span>
        ))}
      </div>
    </div>
  )}

  {gardenNotes.length > 0 ? (
    <div class="cards" id="cardsContainer">
      {gardenNotes.map(note => (
        <a href={`/garden/${note.slug}`} class="card">
          <h3>{note.data.title}</h3>
          {note.data.description && <p>{note.data.description}</p>}
          <div class="meta">
            <span>
              {note.data.date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              })}
            </span>
          </div>
          {note.data.tags.length > 0 && (
            <div class="tags">
              {note.data.tags.map(tag => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          )}
        </a>
      ))}
    </div>
  ) : (
    <div class="empty-state">
      <p>No notes in the garden yet. Plant your first seed!</p>
      <p class="hint">
        Add markdown files to <code>src/content/garden/</code> to get started.
      </p>
    </div>
  )}
</BaseLayout>

<script>
  const toggle = document.getElementById('layoutToggle');
  const container = document.getElementById('cardsContainer');
  const toggleText = toggle?.querySelector('.toggle-text');
  const searchInput = document.getElementById('searchInput');

  // Load saved preference
  const savedLayout = localStorage.getItem('gardenLayout') || 'list';
  if (savedLayout === 'masonry') {
    container?.classList.add('masonry');
    if (toggleText) toggleText.textContent = 'List';
  }

  toggle?.addEventListener('click', () => {
    const isMasonry = container?.classList.toggle('masonry');
    const newLayout = isMasonry ? 'masonry' : 'list';
    localStorage.setItem('gardenLayout', newLayout);
    if (toggleText) toggleText.textContent = isMasonry ? 'List' : 'Masonry';
  });

  // Search functionality
  searchInput?.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase().trim();
    const cards = container?.querySelectorAll('.card');

    cards?.forEach((card) => {
      const title = card.querySelector('h3')?.textContent?.toLowerCase() || '';
      const description = card.querySelector('p')?.textContent?.toLowerCase() || '';
      const tags = Array.from(card.querySelectorAll('.tag'))
        .map(tag => tag.textContent?.toLowerCase() || '')
        .join(' ');

      const matches = title.includes(searchTerm) ||
                     description.includes(searchTerm) ||
                     tags.includes(searchTerm);

      if (matches || searchTerm === '') {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  });
</script>

<style>
  .header {
    margin-bottom: 2rem;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    margin-top: 0.5rem;
  }

  .layout-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-hover);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    color: var(--color-text);
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .layout-toggle:hover {
    background: var(--color-border);
  }

  .toggle-icon {
    font-size: 1.1rem;
  }

  .search-container {
    margin-bottom: 2rem;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg);
    color: var(--color-text);
    font-family: var(--font-sans);
    transition: border-color 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .tags-filter {
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--color-hover);
    border-radius: 8px;
  }

  /* List layout (default) */
  .cards {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: 100vw;
    margin-left: calc(50% - 50vw);
    padding: 0 2rem;
  }

  /* Masonry layout */
  .cards.masonry {
    display: block;
    column-count: 3;
    column-gap: 1rem;
  }

  @media (min-width: 1024px) {
    .cards.masonry {
      column-count: 4;
    }
  }

  @media (max-width: 768px) {
    .cards.masonry {
      column-count: 2;
    }
  }

  .cards.masonry .card {
    display: inline-block;
    width: 100%;
    margin-bottom: 1rem;
  }

  .card {
    display: block;
    color: var(--color-text);
    break-inside: avoid;
  }

  /* Smaller cards */
  .card h3 {
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
  }

  .card p {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }

  .meta {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    font-size: 0.85rem;
  }

  .updated {
    color: var(--color-accent);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--color-text-muted);
  }

  .empty-state p {
    margin-bottom: 0.5rem;
  }

  .hint {
    font-size: 0.9rem;
    margin-top: 1rem;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .cards.masonry {
      column-count: 1;
    }

    .header-content {
      flex-direction: column;
      align-items: stretch;
    }

    .layout-toggle {
      width: 100%;
      justify-content: center;
    }
  }
</style>
