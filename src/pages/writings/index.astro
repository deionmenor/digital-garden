---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const writings = (await getCollection('writings'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const allTags = [...new Set(writings.flatMap(post => post.data.tags))].sort();
---

<BaseLayout title="Writings" description="Read my latest articles and thoughts">
  <div class="header">
    <h1>Writings</h1>
    <p class="subtitle">
      Articles, essays, and thoughts on software development, technology, and more.
    </p>
  </div>

  <div class="search-container">
    <input
      type="text"
      id="searchInput"
      class="search-input"
      placeholder="Search writings..."
      aria-label="Search writings"
    />
  </div>

  {writings.length > 0 ? (
    <div class="cards" id="cardsContainer">
      {writings.map(post => (
        <a href={`/writings/${post.slug}`} class="card">
          {post.data.coverImage && (
            <div class="cover-image">
              <img src={post.data.coverImage} alt={post.data.title} />
            </div>
          )}
          <div class="card-content">
            <h3>{post.data.title}</h3>
            <p>{post.data.description}</p>
            <div class="meta">
              {post.data.date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </div>
            {post.data.tags.length > 0 && (
              <div class="tags">
                {post.data.tags.map(tag => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            )}
          </div>
        </a>
      ))}
    </div>
  ) : (
    <div class="empty-state">
      <p>No writings yet. Check back soon for new content!</p>
      <p class="hint">
        Add markdown files to <code>src/content/writings/</code> to get started.
      </p>
    </div>
  )}
</BaseLayout>

<script>
  const searchInput = document.getElementById('searchInput');
  const container = document.getElementById('cardsContainer');

  // Search functionality
  searchInput?.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase().trim();
    const cards = container?.querySelectorAll('.card');

    cards?.forEach((card) => {
      const title = card.querySelector('h3')?.textContent?.toLowerCase() || '';
      const description = card.querySelector('p')?.textContent?.toLowerCase() || '';
      const tags = Array.from(card.querySelectorAll('.tag'))
        .map(tag => tag.textContent?.toLowerCase() || '')
        .join(' ');

      const matches = title.includes(searchTerm) ||
                     description.includes(searchTerm) ||
                     tags.includes(searchTerm);

      if (matches || searchTerm === '') {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  });
</script>

<style>
  .header {
    margin-bottom: 2rem;
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    margin-top: 0.5rem;
  }

  .search-container {
    margin-bottom: 2rem;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg);
    color: var(--color-text);
    font-family: var(--font-sans);
    transition: border-color 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .cards {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .card {
    display: block;
    color: var(--color-text);
    overflow: hidden;
  }

  .cover-image {
    width: 100%;
    height: 200px;
    overflow: hidden;
    margin: -1.5rem -1.5rem 1rem -1.5rem;
  }

  .cover-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-content {
    padding: 0;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--color-text-muted);
  }

  .empty-state p {
    margin-bottom: 0.5rem;
  }

  .hint {
    font-size: 0.9rem;
    margin-top: 1rem;
  }
</style>
